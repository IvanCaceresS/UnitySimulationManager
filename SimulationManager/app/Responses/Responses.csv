id%|%pregunta%|%respuesta%|%input_tokens%|%output_tokens
1%|%TEST%|%1.PrefabMaterialCreator.cs{public static class PrefabMaterialCreator{const string pF="Assets/Resources/Prefabs",mF="Assets/Resources/PrefabsMaterials";[MenuItem("Tools/Crear Prefabs y Materiales")]public static void CreatePrefabsAndMaterials(){if(!AssetDatabase.IsValidFolder(pF)){AssetDatabase.CreateFolder("Assets/Resources","Prefabs");Debug.Log("Carpeta creada: "+pF);}if(!AssetDatabase.IsValidFolder(mF)){AssetDatabase.CreateFolder("Assets/Resources","PrefabsMaterials");Debug.Log("Carpeta creada: "+mF);}CPAM("SCerevisiae",PrimitiveType.Sphere,new Vector3(5,5,5),new Vector3(90,0,0),0);CPAM("EColi",PrimitiveType.Capsule,new Vector3(.5f,2,0.5f),new Vector3(90,0,0),1);AssetDatabase.SaveAssets();AssetDatabase.Refresh();Debug.Log("Prefabs y materiales creados.");}static void CPAM(string n,PrimitiveType t,Vector3 s,Vector3 r,int c){var o=GameObject.CreatePrimitive(t);o.name=n;o.transform.rotation=Quaternion.Euler(r);o.transform.localScale=s;var col=o.GetComponent<Collider>();if(col!=null)Object.DestroyImmediate(col);if(c==0)o.AddComponent<SphereCollider>();else o.AddComponent<CapsuleCollider>();var sh=Shader.Find("Universal Render Pipeline/Lit");if(sh==null){Debug.LogError("Shader URP/Lit no encontrado.");return;}var m=new Material(sh);m.color=n=="SCerevisiae"?new Color(0,0,1,1):n=="EColi"?new Color(0,1,0,1):Color.white;AssetDatabase.CreateAsset(m,Path.Combine(mF,n+".mat"));AssetDatabase.SaveAssets();AssetDatabase.Refresh();o.GetComponent<Renderer>().sharedMaterial=m;PrefabUtility.SaveAsPrefabAsset(o,Path.Combine(pF,n+".prefab"));Object.DestroyImmediate(o);}}}2.CreatePrefabsOnClick.cs{private void CrearEntidad(Vector3 p){if(currentPrefabIndex>=prefabs.Count)return;var sQ=spawnerQuery.ToEntityArray(Allocator.Temp);if(currentPrefabIndex>=sQ.Length){Debug.LogError($"No se encontró spawner en índice {currentPrefabIndex}");sQ.Dispose();return;}Entity s=sQ[currentPrefabIndex];sQ.Dispose();Entity pe=entityManager.GetComponentData<PrefabEntityComponent>(s).prefab;Entity e=entityManager.Instantiate(pe);float os=entityManager.GetComponentData<LocalTransform>(pe).Scale;quaternion or=entityManager.GetComponentData<LocalTransform>(pe).Rotation;float ry=UnityEngine.Random.Range(0f,360f);quaternion nr=math.mul(or,quaternion.RotateY(math.radians(ry)));float h=os*.5f;float3 ap=new float3(p.x,math.max(p.y+h,h),p.z);entityManager.SetComponentData(e,new LocalTransform{Position=ap,Rotation=nr,Scale=os});string n=prefabs[currentPrefabIndex].name;switch(n){case"EColi":entityManager.AddComponentData(e,new EColiComponent{TimeReference=1200f,SeparationThreshold=0.7f,MaxScale=1f,GrowthTime=0f,GrowthDuration=1200f*0.7f,TimeSinceLastDivision=0f,DivisionInterval=1200f*0.7f,HasGeneratedChild=false,Parent=Entity.Null,IsInitialCell=true,SeparationSign=0});break;case"SCerevisiae":entityManager.AddComponentData(e,new SCerevisiaeComponent{TimeReference=5400f,SeparationThreshold=0.7f,MaxScale=5f,GrowthTime=0f,GrowthDuration=5400f*0.7f,TimeSinceLastDivision=0f,DivisionInterval=5400f*0.7f,HasGeneratedChild=false,Parent=Entity.Null,IsInitialCell=true,SeparationSign=0});break;default:Debug.LogWarning($"No hay componente ECS para '{n}'");break;}AddPhysicsComponents(e,n,os);Debug.Log($"Entidad '{n}' creada en {ap}");}private void AddPhysicsComponents(Entity e,string n,float s){BlobAssetReference<Unity.Physics.Collider>c=default;Material m=new Material{Friction=8f,Restitution=0f};switch(n){case"EColi":c=Unity.Physics.CapsuleCollider.Create(new CapsuleGeometry{Vertex0=new float3(0,-s,0),Vertex1=new float3(0,s,0),Radius=0.25f},CollisionFilter.Default,m);break;case"SCerevisiae":c=Unity.Physics.SphereCollider.Create(new SphereGeometry{Center=float3.zero,Radius=s*0.1f},CollisionFilter.Default,m);break;default:Debug.LogWarning($"No collider para '{n}'");return;}entityManager.AddComponentData(e,new PhysicsCollider{Value=c});if(c.IsCreated){var mp=c.Value.MassProperties;entityManager.AddComponentData(e,PhysicsMass.CreateDynamic(mp,1f));}entityManager.AddComponentData(e,new PhysicsVelocity{Linear=float3.zero,Angular=float3.zero});entityManager.AddComponentData(e,new PhysicsGravityFactor{Value=1f});entityManager.AddComponentData(e,new PhysicsDamping{Linear=0f,Angular=50f});Debug.Log($"Física añadida a '{n}' (fricción alta, damping angular)");}}3.EColiComponent.cs{using Unity.Entities;using Unity.Mathematics;public struct EColiComponent:IComponentData{public float TimeReference,MaxScale,GrowthTime,GrowthDuration,TimeSinceLastDivision,DivisionInterval,SeparationThreshold;public bool HasGeneratedChild,IsInitialCell,TimeReferenceInitialized;public Entity Parent;public int SeparationSign;}}4.SCerevisiaeComponent.cs{using Unity.Entities;using Unity.Mathematics;public struct SCerevisiaeComponent:IComponentData{public float TimeReference,MaxScale,GrowthTime,GrowthDuration,TimeSinceLastDivision,DivisionInterval,SeparationThreshold;public bool HasGeneratedChild,IsInitialCell,TimeReferenceInitialized;public Entity Parent;public int SeparationSign;public float3 GrowthDirection;}}5.EColiSystem.cs{if(transform.Scale>=maxScale){organism.TimeSinceLastDivision+=deltaTime;if(organism.TimeSinceLastDivision>=organism.DivisionInterval){Unity.Mathematics.Random rng=new Unity.Mathematics.Random((uint)(entityInQueryIndex+1)*12345);int s=rng.NextFloat()<0.5f?1:-1;Entity c=ecb.Instantiate(entityInQueryIndex,entity);LocalTransform ct=transform;ct.Scale=0.01f;EColiComponent cd=organism;cd.TimeReferenceInitialized = false;cd.GrowthTime=0f;cd.TimeSinceLastDivision=0f;cd.HasGeneratedChild=false;cd.Parent=entity;cd.IsInitialCell=false;cd.SeparationSign=s;float3 u=math.mul(transform.Rotation,new float3(0,s,0));ct.Position=transform.Position+u*(transform.Scale*0.25f);ecb.SetComponent(entityInQueryIndex,c,ct);ecb.SetComponent(entityInQueryIndex,c,cd);organism.TimeSinceLastDivision=0f;}}if(!organism.IsInitialCell&&organism.Parent!=Entity.Null&&parentMap.TryGetValue(organism.Parent,out ParentData pd)){if(transform.Scale<organism.SeparationThreshold*maxScale){float off=math.lerp(0f,pd.Scale*4.9f,transform.Scale/maxScale);float3 u=math.mul(pd.Rotation,new float3(0,organism.SeparationSign,0));transform.Position=pd.Position+u*off;transform.Rotation=pd.Rotation;}else organism.Parent=Entity.Null;}}6.SCerevisiaeSystem.cs{if(transform.Scale>=maxScale){organism.TimeSinceLastDivision+=deltaTime;if(organism.TimeSinceLastDivision>=organism.DivisionInterval){Unity.Mathematics.Random rng=new Unity.Mathematics.Random((uint)(entityInQueryIndex+1)*99999);float angle=rng.NextFloat(0f,math.PI*2f);float3 rnd=new float3(math.cos(angle),math.sin(angle),0f);Entity child=ecb.Instantiate(entityInQueryIndex,entity);LocalTransform ct=transform;ct.Scale=0.01f;SCerevisiaeComponent cd=organism;cd.TimeReferenceInitialized = false;cd.GrowthTime=0f;cd.TimeSinceLastDivision=0f;cd.IsInitialCell=false;cd.Parent=entity;cd.GrowthDirection=rnd;ct.Position=transform.Position;ecb.SetComponent(entityInQueryIndex,child,ct);ecb.SetComponent(entityInQueryIndex,child,cd);organism.TimeSinceLastDivision=0f;}}if(!organism.IsInitialCell&&organism.Parent!=Entity.Null&&parentMap.TryGetValue(organism.Parent,out ParentData pd)){if(transform.Scale<organism.SeparationThreshold*maxScale){float r=math.clamp(transform.Scale/(organism.SeparationThreshold*maxScale),0f,1f);float off=(pd.Scale*0.5f)*r;float3 wd=math.mul(pd.Rotation,organism.GrowthDirection);transform.Position=pd.Position+wd*off;transform.Rotation=pd.Rotation;}else organism.Parent=Entity.Null;}}%|%2902%|%2745
2%|%TEST%|%1.PrefabMaterialCreator.cs{public static class PrefabMaterialCreator{const string pF="Assets/Resources/Prefabs",mF="Assets/Resources/PrefabsMaterials";[MenuItem("Tools/Crear Prefabs y Materiales")]public static void CreatePrefabsAndMaterials(){if(!AssetDatabase.IsValidFolder(pF)){AssetDatabase.CreateFolder("Assets/Resources","Prefabs");Debug.Log("Carpeta creada: "+pF);}if(!AssetDatabase.IsValidFolder(mF)){AssetDatabase.CreateFolder("Assets/Resources","PrefabsMaterials");Debug.Log("Carpeta creada: "+mF);}CPAM("SCerevisiae",PrimitiveType.Sphere,new Vector3(5,5,5),new Vector3(90,0,0),0);CPAM("EColi",PrimitiveType.Capsule,new Vector3(.5f,2,0.5f),new Vector3(90,0,0),1);AssetDatabase.SaveAssets();AssetDatabase.Refresh();Debug.Log("Prefabs y materiales creados.");}static void CPAM(string n,PrimitiveType t,Vector3 s,Vector3 r,int c){var o=GameObject.CreatePrimitive(t);o.name=n;o.transform.rotation=Quaternion.Euler(r);o.transform.localScale=s;var col=o.GetComponent<Collider>();if(col!=null)Object.DestroyImmediate(col);if(c==0)o.AddComponent<SphereCollider>();else o.AddComponent<CapsuleCollider>();var sh=Shader.Find("Universal Render Pipeline/Lit");if(sh==null){Debug.LogError("Shader URP/Lit no encontrado.");return;}var m=new Material(sh);m.color=n=="SCerevisiae"?new Color(0,0,1,1):n=="EColi"?new Color(0,1,0,1):Color.white;AssetDatabase.CreateAsset(m,Path.Combine(mF,n+".mat"));AssetDatabase.SaveAssets();AssetDatabase.Refresh();o.GetComponent<Renderer>().sharedMaterial=m;PrefabUtility.SaveAsPrefabAsset(o,Path.Combine(pF,n+".prefab"));Object.DestroyImmediate(o);}}}2.CreatePrefabsOnClick.cs{private void CrearEntidad(Vector3 p){if(currentPrefabIndex>=prefabs.Count)return;var sQ=spawnerQuery.ToEntityArray(Allocator.Temp);if(currentPrefabIndex>=sQ.Length){Debug.LogError($"No se encontró spawner en índice {currentPrefabIndex}");sQ.Dispose();return;}Entity s=sQ[currentPrefabIndex];sQ.Dispose();Entity pe=entityManager.GetComponentData<PrefabEntityComponent>(s).prefab;Entity e=entityManager.Instantiate(pe);float os=entityManager.GetComponentData<LocalTransform>(pe).Scale;quaternion or=entityManager.GetComponentData<LocalTransform>(pe).Rotation;float ry=UnityEngine.Random.Range(0f,360f);quaternion nr=math.mul(or,quaternion.RotateY(math.radians(ry)));float h=os*.5f;float3 ap=new float3(p.x,math.max(p.y+h,h),p.z);entityManager.SetComponentData(e,new LocalTransform{Position=ap,Rotation=nr,Scale=os});string n=prefabs[currentPrefabIndex].name;switch(n){case"EColi":entityManager.AddComponentData(e,new EColiComponent{TimeReference=1200f,SeparationThreshold=0.7f,MaxScale=1f,GrowthTime=0f,GrowthDuration=1200f*0.7f,TimeSinceLastDivision=0f,DivisionInterval=1200f*0.7f,HasGeneratedChild=false,Parent=Entity.Null,IsInitialCell=true,SeparationSign=0});break;case"SCerevisiae":entityManager.AddComponentData(e,new SCerevisiaeComponent{TimeReference=5400f,SeparationThreshold=0.7f,MaxScale=5f,GrowthTime=0f,GrowthDuration=5400f*0.7f,TimeSinceLastDivision=0f,DivisionInterval=5400f*0.7f,HasGeneratedChild=false,Parent=Entity.Null,IsInitialCell=true,SeparationSign=0});break;default:Debug.LogWarning($"No hay componente ECS para '{n}'");break;}AddPhysicsComponents(e,n,os);Debug.Log($"Entidad '{n}' creada en {ap}");}private void AddPhysicsComponents(Entity e,string n,float s){BlobAssetReference<Unity.Physics.Collider>c=default;Material m=new Material{Friction=8f,Restitution=0f};switch(n){case"EColi":c=Unity.Physics.CapsuleCollider.Create(new CapsuleGeometry{Vertex0=new float3(0,-s,0),Vertex1=new float3(0,s,0),Radius=0.25f},CollisionFilter.Default,m);break;case"SCerevisiae":c=Unity.Physics.SphereCollider.Create(new SphereGeometry{Center=float3.zero,Radius=s*0.1f},CollisionFilter.Default,m);break;default:Debug.LogWarning($"No collider para '{n}'");return;}entityManager.AddComponentData(e,new PhysicsCollider{Value=c});if(c.IsCreated){var mp=c.Value.MassProperties;entityManager.AddComponentData(e,PhysicsMass.CreateDynamic(mp,1f));}entityManager.AddComponentData(e,new PhysicsVelocity{Linear=float3.zero,Angular=float3.zero});entityManager.AddComponentData(e,new PhysicsGravityFactor{Value=1f});entityManager.AddComponentData(e,new PhysicsDamping{Linear=0f,Angular=50f});Debug.Log($"Física añadida a '{n}' (fricción alta, damping angular)");}}3.EColiComponent.cs{using Unity.Entities;using Unity.Mathematics;public struct EColiComponent:IComponentData{public float TimeReference,MaxScale,GrowthTime,GrowthDuration,TimeSinceLastDivision,DivisionInterval,SeparationThreshold;public bool HasGeneratedChild,IsInitialCell,TimeReferenceInitialized;public Entity Parent;public int SeparationSign;}}4.SCerevisiaeComponent.cs{using Unity.Entities;using Unity.Mathematics;public struct SCerevisiaeComponent:IComponentData{public float TimeReference,MaxScale,GrowthTime,GrowthDuration,TimeSinceLastDivision,DivisionInterval,SeparationThreshold;public bool HasGeneratedChild,IsInitialCell,TimeReferenceInitialized;public Entity Parent;public int SeparationSign;public float3 GrowthDirection;}}5.EColiSystem.cs{if(transform.Scale>=maxScale){organism.TimeSinceLastDivision+=deltaTime;if(organism.TimeSinceLastDivision>=organism.DivisionInterval){Unity.Mathematics.Random rng=new Unity.Mathematics.Random((uint)(entityInQueryIndex+1)*12345);int s=rng.NextFloat()<0.5f?1:-1;Entity c=ecb.Instantiate(entityInQueryIndex,entity);LocalTransform ct=transform;ct.Scale=0.01f;EColiComponent cd=organism;cd.TimeReferenceInitialized = false;cd.GrowthTime=0f;cd.TimeSinceLastDivision=0f;cd.HasGeneratedChild=false;cd.Parent=entity;cd.IsInitialCell=false;cd.SeparationSign=s;float3 u=math.mul(transform.Rotation,new float3(0,s,0));ct.Position=transform.Position+u*(transform.Scale*0.25f);ecb.SetComponent(entityInQueryIndex,c,ct);ecb.SetComponent(entityInQueryIndex,c,cd);organism.TimeSinceLastDivision=0f;}}if(!organism.IsInitialCell&&organism.Parent!=Entity.Null&&parentMap.TryGetValue(organism.Parent,out ParentData pd)){if(transform.Scale<organism.SeparationThreshold*maxScale){float off=math.lerp(0f,pd.Scale*4.9f,transform.Scale/maxScale);float3 u=math.mul(pd.Rotation,new float3(0,organism.SeparationSign,0));transform.Position=pd.Position+u*off;transform.Rotation=pd.Rotation;}else organism.Parent=Entity.Null;}}6.SCerevisiaeSystem.cs{if(transform.Scale>=maxScale){organism.TimeSinceLastDivision+=deltaTime;if(organism.TimeSinceLastDivision>=organism.DivisionInterval){Unity.Mathematics.Random rng=new Unity.Mathematics.Random((uint)(entityInQueryIndex+1)*99999);float angle=rng.NextFloat(0f,math.PI*2f);float3 rnd=new float3(math.cos(angle),math.sin(angle),0f);Entity child=ecb.Instantiate(entityInQueryIndex,entity);LocalTransform ct=transform;ct.Scale=0.01f;SCerevisiaeComponent cd=organism;cd.TimeReferenceInitialized = false;cd.GrowthTime=0f;cd.TimeSinceLastDivision=0f;cd.IsInitialCell=false;cd.Parent=entity;cd.GrowthDirection=rnd;ct.Position=transform.Position;ecb.SetComponent(entityInQueryIndex,child,ct);ecb.SetComponent(entityInQueryIndex,child,cd);organism.TimeSinceLastDivision=0f;}}if(!organism.IsInitialCell&&organism.Parent!=Entity.Null&&parentMap.TryGetValue(organism.Parent,out ParentData pd)){if(transform.Scale<organism.SeparationThreshold*maxScale){float r=math.clamp(transform.Scale/(organism.SeparationThreshold*maxScale),0f,1f);float off=(pd.Scale*0.5f)*r;float3 wd=math.mul(pd.Rotation,organism.GrowthDirection);transform.Position=pd.Position+wd*off;transform.Rotation=pd.Rotation;}else organism.Parent=Entity.Null;}}%|%0%|%0
